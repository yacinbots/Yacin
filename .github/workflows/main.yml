name: Ubuntu VPS + VLESS via Ngrok

on:
  push:

jobs:
  vps-setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip openssh-server

      - name: Setup SSH
        run: |
          sudo mkdir -p /var/run/sshd
          echo 'root:Admin@123' | sudo chpasswd
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart

      - name: Install Xray
        run: |
          sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" install

      - name: Generate UUID
        run: |
          echo "UUID=$(cat /proc/sys/kernel/random/uuid)" >> $GITHUB_ENV

      - name: Configure Xray
        run: |
          sudo tee /usr/local/etc/xray/config.json > /dev/null <<EOF
{
  "inbounds": [
    {
      "port": 10000,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "${UUID}"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": {
          "path": "/dark"
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

          sudo systemctl restart xray
          sudo systemctl enable xray

      - name: Install ngrok
        run: |
          curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/
          ngrok config add-authtoken 2gzCXiehyX6Dvdjyam6CeA3P7wN_4ZRSp9hHWtNdUrEMfW7A5

      - name: Start ngrok tunnel
        run: |
          ngrok tcp 10000 --log stdout > ngrok.log &
          sleep 10

          tunnel=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | sed 's/tcp:\/\///')

          HOST=$(echo $tunnel | cut -d: -f1)
          PORT=$(echo $tunnel | cut -d: -f2)

          echo "======================================"
          echo " VPS READY "
          echo "======================================"
          echo "SSH LOGIN"
          echo "Host: $HOST"
          echo "Port: $PORT"
          echo "User: root"
          echo "Pass: Admin@123"
          echo ""
          echo "VLESS CONFIG"
          echo "Address: $HOST"
          echo "Port: $PORT"
          echo "UUID: ${UUID}"
          echo "Path: /dark"
          echo "Network: ws"
          echo "TLS: off"
          echo "======================================"

      - name: Keep VPS alive
        run: |
          while true; do sleep 300; done
