name: Free VPS via ngrok SSH

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install SSH and tools
        run: |
          sudo apt update
          sudo apt install -y openssh-server curl unzip sudo

      - name: Set root password
        run: |
          echo "root:root123" | sudo chpasswd

      - name: Enable root login
        run: |
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart

      - name: Install ngrok
        run: |
          curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin

      - name: Set ngrok token
        run: |
          ngrok config add-authtoken 2gzCXiehyX6Dvdjyam6CeA3P7wN_4ZRSp9hHWtNdUrEMfW7A5

      - name: Start ngrok SSH tunnel
        run: |
          ngrok tcp 22 &
          sleep 10

      - name: Show SSH connection info
        run: |
          curl -s http://127.0.0.1:4040/api/tunnels

      - name: Keep VPS alive
        run: |
          echo "VPS is ready"
          echo "User: root"
          echo "Pass: root123"
          while true; do sleep 60; done
