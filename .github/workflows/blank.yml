name: Ubuntu VPS + Ngrok ููุงุชุตุงู ุนู ุจุนุฏ

on:
  push:
    branches:
      - main

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ุชุซุจูุช ุงูุญุฒู ุงูุฃุณุงุณูุฉ
        run: |
          sudo apt update
          sudo apt install -y curl wget openssh-server unzip

      - name: ุฅุนุฏุงุฏ ูุชุดุบูู SSH
        run: |
          # ุฅูุดุงุก ูุฌูุฏ SSH
          sudo mkdir -p /var/run/sshd

          # ุชุบููุฑ ูููุฉ ูุฑูุฑ root
          echo "root:Admin@123" | sudo chpasswd

          # ุงูุณูุงุญ ุจุชุณุฌูู ุงูุฏุฎูู ุจูููุฉ ุงููุฑูุฑ
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

          # ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุฉ SSH
          sudo service ssh restart
          echo "โ ุชู ุชุดุบูู SSH ุจูุฌุงุญ"

      - name: ุฅูุดุงุก ูุฌูุฏ ูููููุงุช ุงูุตูุชูุฉ
        run: |
          mkdir -p ~/quran-audio
          cd ~/quran-audio
          echo "๐ ุชู ุฅูุดุงุก ูุฌูุฏ quran-audio"

      - name: ุชุญููู ูููุงุช ุงูุตูุช
        run: |
          cd ~/quran-audio
          BASE_URL="https://server12.mp3quran.net/maher/Almusshaf-Al-Mo-lim"
          
          echo "==========================================="
          echo "ุจุฏุก ุชุญููู ุงููููุงุช ุงููุชููุฑุฉ..."
          echo "==========================================="
          
          # ุชุญููู ุงูููู ุงูุฃูู
          echo "๐ฅ ุชุญููู: 001.mp3"
          wget -q --show-progress "${BASE_URL}/001.mp3" -O "001.mp3"
          
          # ุชุญููู ุงููููุงุช ูู 078 ุฅูู 114
          for i in $(seq 78 114); do
            if [ $i -lt 100 ]; then
              FILE_NUM="0${i}"
            else
              FILE_NUM="${i}"
            fi
            
            echo "๐ฅ ุชุญููู: ${FILE_NUM}.mp3"
            wget -q --show-progress "${BASE_URL}/${FILE_NUM}.mp3" -O "${FILE_NUM}.mp3"
            sleep 1
          done
          
          echo ""
          echo "โ ุชู ุชุญููู 38 ููู ุจูุฌุงุญ"
          echo "๐ ุงูุญุฌู ุงูุฅุฌูุงูู: $(du -sh ~/quran-audio/ | cut -f1)"

      - name: ุชุซุจูุช ูุชุดุบูู ngrok
        run: |
          # ุชุญููู ูุชุซุจูุช ngrok
          curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip -o ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok
          
          # ุฅุถุงูุฉ ุงูุชููู
          ngrok config add-authtoken 2gzCXiehyX6Dvdjyam6CeA3P7wN_4ZRSp9hHWtNdUrEMfW7A5
          
          echo "โ ุชู ุชุซุจูุช ngrok"

      - name: ุชุดุบูู ุฃููุงู ngrok
        run: |
          # ุชุดุบูู ููู SSH (ุงููููุฐ 22)
          echo "๐ ุชุดุบูู ููู SSH ุนูู ุงููููุฐ 22..."
          ngrok tcp 22 --log=stdout > ngrok-ssh.log &
          
          # ุชุดุบูู ููู HTTP ูููููุงุช (ุงููููุฐ 8080)
          echo "๐ ุชุดุบูู ููู HTTP ูููููุงุช ุนูู ุงููููุฐ 8080..."
          cd ~/quran-audio/
          python3 -m http.server 8080 > /dev/null 2>&1 &
          ngrok http 8080 --log=stdout > ngrok-http.log &
          
          # ุงูุชุธุงุฑ ุชุดุบูู ุงูุฃููุงู
          echo "โณ ุฌุงุฑู ุชุดุบูู ุงูุฃููุงู..."
          sleep 20

      - name: ุงูุญุตูู ุนูู ุฑูุงุจุท ngrok
        run: |
          echo ""
          echo "==========================================="
          echo "๐ฅ VPS ุฌุงูุฒ ููุงุชุตุงู ุนู ุจุนุฏ! ๐ฅ"
          echo "==========================================="
          echo ""
          
          # ุงูุญุตูู ุนูู ุฑุงุจุท SSH
          SSH_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
          if [ ! -z "$SSH_URL" ]; then
            SSH_HOST=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f1)
            SSH_PORT=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f2)
            
            echo "๐น ุงุชุตุงู SSH:"
            echo "   ุงูุฃูุฑ: ssh root@$SSH_HOST -p $SSH_PORT"
            echo "   ูููุฉ ุงููุฑูุฑ: Admin@123"
            echo ""
          else
            echo "โ ูุดู ูู ุงูุญุตูู ุนูู ุฑุงุจุท SSH"
          fi
          
          # ุงูุญุตูู ุนูู ุฑุงุจุท HTTP ูููููุงุช
          HTTP_URL=$(curl -s http://127.0.0.1:4041/api/tunnels 2>/dev/null | grep -o 'https://[^"]*' | head -1)
          if [ -z "$HTTP_URL" ]; then
            HTTP_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          fi
          
          if [ ! -z "$HTTP_URL" ]; then
            echo "๐น ุฑุงุจุท ุชุญููู ุงููููุงุช:"
            echo "   $HTTP_URL"
            echo ""
          else
            echo "โ ูุดู ูู ุงูุญุตูู ุนูู ุฑุงุจุท HTTP"
          fi
          
          echo ""
          echo "==========================================="
          echo ""

      - name: ุฅูุดุงุก ุณูุฑุจุช ูุณุงุนุฏ ููุงุชุตุงู
        run: |
          cd ~
          
          # ุงูุญุตูู ุนูู ุฑูุงุจุท ngrok
          SSH_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
          SSH_HOST=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f1)
          SSH_PORT=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f2)
          
          HTTP_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          
          # ุฅูุดุงุก ููู ูุนูููุงุช
          cat > connection_info.txt << 'EOF'
===========================================
ูุนูููุงุช ุงูุงุชุตุงู ุจุฌูุงุฒ VPS
===========================================

๐ฑ SSH:
   ุงูุฃูุฑ: ssh root@___SSH_HOST___ -p ___SSH_PORT___
   ูููุฉ ุงููุฑูุฑ: Admin@123

๐ HTTP:
   ุงูุฑุงุจุท: ___HTTP_URL___

๐ ูุชุญููู ุงููููุงุช ูู Termux:
   cd ~/storage/downloads
   mkdir quran
   cd quran
   
   for i in 001 078 079 080 081 082 083 084 085 086 087 088 089 090 091 092 093 094 095 096 097 098 099 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114; do
     wget ___HTTP_URL___/\${i}.mp3
   done

โ 38 ููู ูุชุงุญ
===========================================
EOF

          # ุงุณุชุจุฏุงู ุงููุชุบูุฑุงุช
          sed -i "s|___SSH_HOST___|$SSH_HOST|g" connection_info.txt
          sed -i "s|___SSH_PORT___|$SSH_PORT|g" connection_info.txt
          sed -i "s|___HTTP_URL___|$HTTP_URL|g" connection_info.txt
          
          echo "๐ ุชู ุฅูุดุงุก ููู connection_info.txt"
          cat connection_info.txt

      - name: ุฅุจูุงุก ุงูุฌูุงุฒ ูุดุทุงู
        run: |
          # ุงูุญุตูู ุนูู ุงูุฑูุงุจุท
          SSH_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
          SSH_HOST=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f1)
          SSH_PORT=$(echo $SSH_URL | sed 's/tcp:\/\///' | cut -d: -f2)
          HTTP_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(( (ELAPSED % 3600) / 60 ))
            SECONDS=$((ELAPSED % 60))
            REMAINING=$((21600 - ELAPSED))  # 6 ุณุงุนุงุช = 21600 ุซุงููุฉ
            REMAINING_MIN=$((REMAINING / 60))
            
            clear 2>/dev/null || true
            echo "==========================================="
            echo "๐ฅ VPS ูุชุงุญ ููุงุชุตุงู ุนู ุจุนุฏ ๐ฅ"
            echo "==========================================="
            echo ""
            echo "โฑ๏ธ  ุงูููุช ุงููููุถู: ${HOURS}h ${MINUTES}m ${SECONDS}s"
            echo "โณ ุงูููุช ุงููุชุจูู: $((REMAINING_MIN / 60))h $((REMAINING_MIN % 60))m"
            echo ""
            echo "๐ฑ ุงุชุตุงู SSH:"
            echo "   ssh root@$SSH_HOST -p $SSH_PORT"
            echo "   ูููุฉ ุงููุฑูุฑ: Admin@123"
            echo ""
            echo "๐ ุฑุงุจุท ุงููููุงุช:"
            echo "   $HTTP_URL"
            echo ""
            echo "๐ ุญุงูุฉ ุงููููุงุช:"
            cd ~/quran-audio/ 2>/dev/null
            MP3_COUNT=$(ls -1 *.mp3 2>/dev/null | wc -l)
            TOTAL_SIZE=$(du -sh . 2>/dev/null | cut -f1)
            echo "   ุงููููุงุช: $MP3_COUNT | ุงูุญุฌู: $TOTAL_SIZE"
            echo ""
            echo "๐ ูุซุงู ุชุญููู:"
            echo "   wget $HTTP_URL/001.mp3"
            echo ""
            echo "๐ ุชุญุฏูุซ ูู 30 ุซุงููุฉ"
            echo "==========================================="
            
            sleep 30
          done
