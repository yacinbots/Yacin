name: ุชุดุบูู VPS ูุชุญููู ูููุงุช ุงูุตูุช

on:
  push:
    branches:
      - main  # ุฃู ุงููุฑุน ุงูุฐู ุชุณุชุฎุฏููุ ูุซูุงู 'master'

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # ุณูุจูู ูุดุทุงู ููุฏุฉ 6 ุณุงุนุงุช

    steps:
      - name: ุชุซุจูุช ุงูุญุฒู ุงูุฃุณุงุณูุฉ
        run: |
          sudo apt update
          sudo apt install -y curl wget openssh-server

      - name: ุฅุนุฏุงุฏ ูุชุดุบูู SSH
        run: |
          # ุฅูุดุงุก ูุฌูุฏ SSH
          sudo mkdir -p /var/run/sshd

          # ุชุบููุฑ ูููุฉ ูุฑูุฑ root ูุชุณููู ุงูุฏุฎูู
          echo "root:Admin@123" | sudo chpasswd

          # ุงูุณูุงุญ ุจุชุณุฌูู ุงูุฏุฎูู ููููุฉ ุงููุฑูุฑ
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

          # ุฅุนุงุฏุฉ ุชุดุบูู ุฎุฏูุฉ SSH
          sudo service ssh restart
          echo "ุชู ุชุดุบูู SSH ุจูุฌุงุญ."

      - name: ุฅูุดุงุก ูุฌูุฏ ูููููุงุช ุงูุตูุชูุฉ
        run: |
          mkdir -p ~/quran-audio
          echo "ุชู ุฅูุดุงุก ูุฌูุฏ quran-audio ูู ูุณุงุฑ ุงููุณุชุฎุฏู."

      - name: ุชุญููู ูููุงุช ุงูุตูุช (ูู 001 ุฅูู 114)
        run: |
          cd ~/quran-audio
          BASE_URL="https://server12.mp3quran.net/maher/Almusshaf-Al-Mo-lim"
          echo "ุจุฏุก ุชุญููู 114 ููู ุตูุชู..."
          
          # ูุงุฆูุฉ ุงููููุงุช ุงููุคูุฏุฉ ุงูููุฌูุฏุฉ (ุจูุงุกู ุนูู ุงูุชุญููู ุงููุงุฌุญ ููููู ุงูุฃูู)
          # ุณุฃุญุงูู ุชุญููู ูู ููู ุจุดูู ูุณุชูู ุฏูู ุฅููุงู ุงูุชุดุบูู ุนูุฏ ูุดู ุฃุญุฏูู
          
          # ุญููุฉ for ูุชุญููู ุงููููุงุช ูู 1 ุฅูู 114
          for i in $(seq -f "%03g" 1 114); do
            FILE_NAME="${i}.mp3"
            URL="${BASE_URL}/${FILE_NAME}"
            
            echo "ุฌุงุฑู ูุญุงููุฉ ุชุญููู: ${FILE_NAME}"
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุงูููู ูุจู ุงูุชุญููู (ูุญุงููุฉ ุงูุญุตูู ุนูู ุงูููุฏุฑ ููุท)
            if wget --spider "${URL}" 2>/dev/null; then
              echo "โ ุงูููู ููุฌูุฏุ ุฌุงุฑู ุงูุชุญููู..."
              # ุชุญููู ุงูููู ูุน ุชุฌุงูู ุงูุฃุฎุทุงุก ูุนุฏู ุฅููุงู ุงูุชุดุบูู
              wget -q --show-progress "${URL}" -O "${FILE_NAME}" || echo "โ๏ธ ูุดู ุชุญููู ${FILE_NAME} ูููููุง ุณูููู"
              
              if [ -f "${FILE_NAME}" ] && [ -s "${FILE_NAME}" ]; then
                echo "โ ุชู ุชุญููู ุจูุฌุงุญ: ${FILE_NAME}"
              else
                echo "โ๏ธ ุงูููู ${FILE_NAME} ุชู ุชุญูููู ูููู ูุงุฑุบ ุฃู ูุงูุต"
                # ุญุฐู ุงูููู ุงููุงุฑุบ ุฅู ูุฌุฏ
                rm -f "${FILE_NAME}"
              fi
            else
              echo "โ๏ธ ุงูููู ${FILE_NAME} ุบูุฑ ููุฌูุฏ ุนูู ุงูุฎุงุฏูุ ูุชุฎุทุงู"
            fi
            
            # ุชุฃุฎูุฑ ุจุณูุท ุจูู ุงูุทูุจุงุช ูุชุฌูุจ ุญุธุฑ ุงูุฎุงุฏู
            sleep 1
          done
          
          echo ""
          echo "==========================================="
          echo "ููุฎุต ุงูุชุญููู:"
          echo "==========================================="
          
          # ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุชุญููู
          TOTAL_FILES=$(ls -1 *.mp3 2>/dev/null | wc -l)
          if [ "$TOTAL_FILES" -gt 0 ]; then
            echo "โ ุชู ุชุญููู $TOTAL_FILES ููู ุจูุฌุงุญ"
            echo ""
            echo "ุงููููุงุช ุงูุชู ุชู ุชุญููููุง:"
            ls -la *.mp3 | sort
          else
            echo "โ ูู ูุชู ุชุญููู ุฃู ููู!"
          fi
          
          echo ""
          echo "ุงููููุงุช ุงูููุฌูุฏุฉ ูู ุงููุฌูุฏ:"
          ls -la ~/quran-audio/

      - name: ุนุฑุถ ูุนูููุงุช ุงูุฅุชุตุงู (SSH)
        run: |
          echo ""
          echo "==========================================="
          echo "โ ุฌูุงุฒ VPS ุฌุงูุฒ ููุงุณุชุฎุฏุงู! โ"
          echo "==========================================="
          echo ""
          echo "๐น ูุนูููุงุช ุงูุงุชุตุงู ุนุจุฑ SSH:"
          echo "   ุงููุถูู: 127.0.0.1 (ุฃู localhost)"
          echo "   ุงููููุฐ: 22"
          echo "   ุงููุณุชุฎุฏู: root"
          echo "   ูููุฉ ุงููุฑูุฑ: Admin@123"
          echo ""
          echo "๐น ูููุน ุงููููุงุช ุงูุตูุชูุฉ:"
          echo "   ~/quran-audio/  (ุฃู /home/runner/quran-audio/)"
          echo ""
          echo "๐น ุนุฏุฏ ุงููููุงุช ุงูุชู ุชู ุชุญููููุง:"
          cd ~/quran-audio/ && ls -1 *.mp3 2>/dev/null | wc -l || echo "0"
          echo ""
          echo "โ๏ธ  ููุงุญุธุฉ: ูุฐุง ุงูุฌูุงุฒ ูุนูู ุฏุงุฎู GitHub Actions"
          echo "    ููุง ูููู ุงูุงุชุตุงู ุจู ูู ุงูุฅูุชุฑูุช ูุจุงุดุฑุฉ."
          echo "==========================================="
          echo ""

      - name: ุฅูุดุงุก ุฑุงุจุท ุชุญููู ูููููุงุช (HTTP Server ุจุณูุท)
        run: |
          # ุชุดุบูู ุฎุงุฏู HTTP ุจุณูุท ููุดุงุฑูุฉ ุงููููุงุช
          cd ~/quran-audio/
          echo "โ ุชู ุชุดุบูู ุฎุงุฏู HTTP ุนูู ุงููููุฐ 8080"
          echo "   ููุดุงุฑูุฉ ุงููููุงุชุ ุงุณุชุฎุฏู: http://localhost:8080"
          echo ""
          echo "๐ ูุชุญููู ุงููููุงุช ูู ุฌูุงุฒู ุงููุญููุ ุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงู ngrok ุฃู ุฎุฏูุฉ ููุงุซูุฉ:"
          echo "   ngrok http 8080"
          echo ""
          # ุชุดุบูู ุฎุงุฏู HTTP ูู ุงูุฎูููุฉ
          python3 -m http.server 8080 > /dev/null 2>&1 &
          sleep 2
          echo "โ ุฎุงุฏู HTTP ูุนูู ุงูุขู"

      - name: ุฅุจูุงุก ุงูุฌูุงุฒ ูุดุทุงู
        run: |
          echo ""
          echo "==========================================="
          echo "๐ข ุงูุฌูุงุฒ ูุนูู ุจูุดุงุท - ุณูุชู ุชุญุฏูุซ ุงูุญุงูุฉ ูู ุฏูููุฉ"
          echo "==========================================="
          echo ""
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER + 1))
            HOURS=$((COUNTER / 60))
            MINUTES=$((COUNTER % 60))
            
            # ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงููููุงุช
            cd ~/quran-audio/ 2>/dev/null
            MP3_COUNT=$(ls -1 *.mp3 2>/dev/null | wc -l)
            TOTAL_SIZE=$(du -sh 2>/dev/null | cut -f1)
            
            echo "[$(date)] - ุงูููุช ุงููููุถู: ${HOURES}h ${MINUTES}m | ุงููููุงุช: $MP3_COUNT | ุงูุญุฌู: $TOTAL_SIZE"
            sleep 60  # ููุงู ููุฏุฉ ุฏูููุฉ
          done
