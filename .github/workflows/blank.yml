name: Ubuntu VPS + Ngrok ููุงุชุตุงู ุนู ุจุนุฏ

on:
  push:
    branches:
      - main

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ุชุซุจูุช ุงูุญุฒู ุงูุฃุณุงุณูุฉ
        run: |
          sudo apt update
          sudo apt install -y curl wget openssh-server unzip

      - name: ุฅุนุฏุงุฏ ูุชุดุบูู SSH
        run: |
          sudo mkdir -p /var/run/sshd
          echo "root:Admin@123" | sudo chpasswd
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart
          echo "โ SSH ุฌุงูุฒ"

      - name: ุฅูุดุงุก ูุฌูุฏ ูููููุงุช
        run: |
          mkdir -p ~/quran-audio
          cd ~/quran-audio
          echo "๐ ูุฌูู quran-audio"

      - name: ุชุญููู ูููุงุช ุงูุตูุช
        run: |
          cd ~/quran-audio
          BASE_URL="https://server12.mp3quran.net/maher/Almusshaf-Al-Mo-lim"
          
          echo "๐ฅ ุชุญููู 001.mp3"
          wget -q --show-progress "${BASE_URL}/001.mp3" -O "001.mp3"
          
          for i in $(seq 78 114); do
            if [ $i -lt 100 ]; then
              NUM="0${i}"
            else
              NUM="${i}"
            fi
            echo "๐ฅ ุชุญููู ${NUM}.mp3"
            wget -q --show-progress "${BASE_URL}/${NUM}.mp3" -O "${NUM}.mp3"
            sleep 1
          done
          
          echo "โ ุชู ุชุญููู 38 ููู"

      - name: ุชุซุจูุช ngrok
        run: |
          curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip -o ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok
          ngrok config add-authtoken 2gzCXiehyX6Dvdjyam6CeA3P7wN_4ZRSp9hHWtNdUrEMfW7A5
          echo "โ ngrok ูุซุจุช"

      - name: ุชุดุบูู ุงูุฃููุงู
        run: |
          # ููู SSH
          ngrok tcp 22 --log=stdout > /dev/null &
          
          # ุฎุงุฏู HTTP
          cd ~/quran-audio/
          python3 -m http.server 8080 > /dev/null 2>&1 &
          
          # ููู HTTP
          ngrok http 8080 --log=stdout > /dev/null &
          
          sleep 15
          echo "โ ุงูุฃููุงู ูุดุชุบูุฉ"

      - name: ุนุฑุถ ูุนูููุงุช ุงูุงุชุตุงู
        run: |
          # ุงูุญุตูู ุนูู ุฑูุงุจุท ngrok
          SSH_INFO=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'tcp://[^"]*' | head -1)
          HTTP_INFO=$(curl -s http://127.0.0.1:4040/api/tunnels | grep -o 'https://[^"]*' | head -1)
          
          if [ ! -z "$SSH_INFO" ]; then
            SSH_HOST=$(echo $SSH_INFO | sed 's/tcp:\/\///' | cut -d: -f1)
            SSH_PORT=$(echo $SSH_INFO | sed 's/tcp:\/\///' | cut -d: -f2)
          fi
          
          # ุนุฑุถ ุงููุนูููุงุช
          echo "==========================================="
          echo "๐ฅ VPS ุฌุงูุฒ ููุงุชุตุงู ๐ฅ"
          echo "==========================================="
          echo ""
          
          if [ ! -z "$SSH_INFO" ]; then
            echo "๐ฑ SSH:"
            echo "   ssh root@$SSH_HOST -p $SSH_PORT"
            echo "   password: Admin@123"
            echo ""
          fi
          
          if [ ! -z "$HTTP_INFO" ]; then
            echo "๐ ุฑุงุจุท ุงููููุงุช:"
            echo "   $HTTP_INFO"
            echo ""
            echo "๐ฅ ุชุญููู ูุซุงู:"
            echo "   wget $HTTP_INFO/001.mp3"
            echo ""
          fi
          
          echo "โณ ุงููุฏุฉ: 6 ุณุงุนุงุช"
          echo "==========================================="

      - name: ุฅุจูุงุก ุงูุฌูุงุฒ ูุดุทุงู
        run: |
          while true; do
            sleep 300
          done
