name: ØªØ´ØºÙŠÙ„ VPS ÙˆØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª

on:
  push:
    branches:
      - main

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        run: |
          sudo apt update
          sudo apt install -y curl wget openssh-server python3

      - name: Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØ´ØºÙŠÙ„ SSH
        run: |
          sudo mkdir -p /var/run/sshd
          echo "root:Admin@123" | sudo chpasswd
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo service ssh restart
          echo "ØªÙ… ØªØ´ØºÙŠÙ„ SSH Ø¨Ù†Ø¬Ø§Ø­."

      - name: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©
        run: |
          mkdir -p ~/quran-audio
          cd ~/quran-audio
          echo "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ quran-audio"

      - name: ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª (Ø§Ù„Ù…ØªÙˆÙØ±Ø© ÙÙ‚Ø·)
        run: |
          cd ~/quran-audio
          BASE_URL="https://server12.mp3quran.net/maher/Almusshaf-Al-Mo-lim"
          
          echo "==========================================="
          echo "Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©..."
          echo "==========================================="
          
          # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ÙˆÙ„ (001.mp3)
          echo "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: 001.mp3"
          wget -q --show-progress "${BASE_URL}/001.mp3" -O "001.mp3"
          
          if [ -f "001.mp3" ] && [ -s "001.mp3" ]; then
            echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ 001.mp3 Ø¨Ù†Ø¬Ø§Ø­"
          else
            echo "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ 001.mp3"
          fi
          
          echo ""
          echo "-------------------------------------------"
          echo "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† 078 Ø¥Ù„Ù‰ 114..."
          echo "-------------------------------------------"
          
          # 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† 078 Ø¥Ù„Ù‰ 114
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          
          for i in $(seq 78 114); do
            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø«Ù„Ø§Ø«Ø© Ø£Ø±Ù‚Ø§Ù… (078, 079, ... 114)
            if [ $i -lt 100 ]; then
              FILE_NUM="0${i}"
            else
              FILE_NUM="${i}"
            fi
            
            FILE_NAME="${FILE_NUM}.mp3"
            URL="${BASE_URL}/${FILE_NAME}"
            
            echo "Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„: ${FILE_NAME}"
            
            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
            if wget -q --show-progress "${URL}" -O "${FILE_NAME}"; then
              echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„: ${FILE_NAME}"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            else
              echo "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„: ${FILE_NAME}"
              FAIL_COUNT=$((FAIL_COUNT + 1))
              rm -f "${FILE_NAME}"  # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªØ§Ù„Ù Ø¥Ù† ÙˆØ¬Ø¯
            fi
            
            echo "-----------------------------------"
            sleep 1  # ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
          done
          
          echo ""
          echo "==========================================="
          echo "Ù…Ù„Ø®Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„:"
          echo "==========================================="
          echo "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­: $((SUCCESS_COUNT + 1)) Ù…Ù„ÙØ§Øª"  # +1 Ù„Ù„Ù…Ù„Ù 001
          echo "âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„: $FAIL_COUNT Ù…Ù„ÙØ§Øª"
          echo ""
          echo "Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹:"
          ls -la *.mp3 | sort
          
          # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
          TOTAL_SIZE=$(du -sh . | cut -f1)
          echo ""
          echo "Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ù…Ù„ÙØ§Øª: $TOTAL_SIZE"

      - name: Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØªØµØ§Ù„
        run: |
          cd ~/quran-audio/
          MP3_COUNT=$(ls -1 *.mp3 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh . 2>/dev/null | cut -f1)
          
          echo ""
          echo "==========================================="
          echo "âœ… Ø¬Ù‡Ø§Ø² VPS Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…! âœ…"
          echo "==========================================="
          echo ""
          echo "ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ø¨Ø± SSH:"
          echo "   Ø§Ù„Ù…Ø¶ÙŠÙ: 127.0.0.1"
          echo "   Ø§Ù„Ù…Ù†ÙØ°: 22"
          echo "   Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: root"
          echo "   ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: Admin@123"
          echo ""
          echo "ğŸ”¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ©:"
          echo "   Ø§Ù„Ù…ÙˆÙ‚Ø¹: ~/quran-audio/"
          echo "   Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: $MP3_COUNT Ù…Ù„Ù"
          echo "   Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: $TOTAL_SIZE"
          echo ""
          echo "ğŸ”¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©:"
          echo "   - 001.mp3 (Ø§Ù„ÙØ§ØªØ­Ø©)"
          echo "   - Ù…Ù† 078.mp3 Ø¥Ù„Ù‰ 114.mp3 (Ù…Ù† Ø§Ù„Ù†Ø¨Ø£ Ø­ØªÙ‰ Ø§Ù„Ù†Ø§Ø³)"
          echo ""

      - name: ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… HTTP Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª
        run: |
          cd ~/quran-audio/
          
          # Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø© HTML Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ© - Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
              <meta charset="UTF-8">
              <style>
                  body { font-family: Arial; margin: 20px; background: #f5f5f5; }
                  h1 { color: #2c3e50; }
                  ul { list-style: none; padding: 0; }
                  li { 
                      padding: 10px; 
                      margin: 5px 0; 
                      background: white; 
                      border-radius: 5px;
                      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                  }
                  a { 
                      text-decoration: none; 
                      color: #3498db; 
                      font-weight: bold;
                  }
                  a:hover { color: #2980b9; }
                  .count { color: #7f8c8d; font-size: 14px; }
              </style>
          </head>
          <body>
              <h1>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØªÙŠØ© - Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
              <p class="count">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª: $(ls -1 *.mp3 2>/dev/null | wc -l)</p>
              <ul>
          EOF
          
          # Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø±ØªØ¨Ø©
          for file in $(ls -1 *.mp3 | sort); do
            size=$(du -h "$file" | cut -f1)
            echo "<li><a href='/$file'>$file</a> <span style='color:#7f8c8d'>($size)</span></li>" >> index.html
          done
          
          cat >> index.html << EOF
              </ul>
          </body>
          </html>
          EOF
          
          echo "âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… HTTP Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° 8080"
          echo "   Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø§ÙØªØ­: http://localhost:8080"
          echo ""
          echo "ğŸ”— Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø¹ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØŒ Ø§Ø³ØªØ®Ø¯Ù…:"
          echo "   ngrok http 8080  (Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨ØªØ«Ø¨ÙŠØª ngrok)"
          
          # ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… HTTP
          python3 -m http.server 8080 > /dev/null 2>&1 &
          sleep 2
          echo "âœ… Ø®Ø§Ø¯Ù… HTTP ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†"

      - name: Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù†Ø´Ø·Ø§Ù‹
        run: |
          echo ""
          echo "==========================================="
          echo "ğŸŸ¢ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙŠØ¹Ù…Ù„ - ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©"
          echo "==========================================="
          echo ""
          
          START_TIME=$(date +%s)
          
          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(( (ELAPSED % 3600) / 60 ))
            SECONDS=$((ELAPSED % 60))
            
            cd ~/quran-audio/ 2>/dev/null
            MP3_COUNT=$(ls -1 *.mp3 2>/dev/null | wc -l)
            TOTAL_SIZE=$(du -sh . 2>/dev/null | cut -f1)
            
            echo "[$(date)] Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ: ${HOURS}h ${MINUTES}m ${SECONDS}s | Ø§Ù„Ù…Ù„ÙØ§Øª: $MP3_COUNT | Ø§Ù„Ø­Ø¬Ù…: $TOTAL_SIZE"
            
            # Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ù…Ù„ÙØ§Øª Ù…Ø¶Ø§ÙØ©
            if [ $MP3_COUNT -gt 0 ]; then
              LATEST_FILES=$(ls -t *.mp3 2>/dev/null | head -5 | tr '\n' ' ')
              echo "   Ø¢Ø®Ø± Ø§Ù„Ù…Ù„ÙØ§Øª: $LATEST_FILES"
            fi
            
            echo "-----------------------------------"
            sleep 60
          done
