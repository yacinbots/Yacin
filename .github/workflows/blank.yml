name: Ubuntu VPS + VLESS via Ngrok

on:
  push:

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl unzip openssh-server

      - name: Setup SSH
        run: |
          sudo mkdir -p /var/run/sshd
          echo root:Admin@123 | sudo chpasswd

          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

          sudo service ssh restart

      - name: Install Xray
        run: |
          sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" install

      - name: Generate UUID
        run: |
          UUID=$(cat /proc/sys/kernel/random/uuid)
          echo "UUID=$UUID" >> $GITHUB_ENV

      - name: Write Xray config
        run: |
          sudo mkdir -p /usr/local/etc/xray

          sudo bash -c "cat > /usr/local/etc/xray/config.json" << EOF
{
  "inbounds": [
    {
      "port": 10000,
      "protocol": "vless",
      "settings": {
        "clients": [
          {
            "id": "$UUID"
          }
        ],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "ws",
        "wsSettings": {
          "path": "/dark"
        }
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom"
    }
  ]
}
EOF

          sudo systemctl restart xray
          sudo systemctl enable xray

      - name: Install ngrok
        run: |
          curl -L https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip -o ngrok.zip
          unzip -o ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok

          ngrok config add-authtoken 2gzCXiehyX6Dvdjyam6CeA3P7wN_4ZRSp9hHWtNdUrEMfW7A5

      - name: Start tunnel
        run: |
          ngrok tcp 10000 > ngrok.log &
          sleep 15

          URL=$(curl -s http://127.0.0.1:4040/api/tunnels | grep public_url | cut -d '"' -f4)

          HOST=$(echo $URL | sed 's/tcp:\/\///' | cut -d: -f1)
          PORT=$(echo $URL | sed 's/tcp:\/\///' | cut -d: -f2)

          echo "================================"
          echo "VPS READY"
          echo "================================"
          echo "Host: $HOST"
          echo "Port: $PORT"
          echo "User: root"
          echo "Pass: Admin@123"
          echo ""
          echo "UUID: $UUID"
          echo "Path: /dark"
          echo "Network: ws"
          echo ""
          echo "VLESS URL:"
          echo "vless://$UUID@$HOST:$PORT?type=ws&path=%2Fdark&security=none"
          echo "================================"

      - name: Keep alive
        run: |
          while true; do
            sleep 300
          done
